/*
 *    Geotoolkit.org - An Open Source Java GIS Toolkit
 *    http://www.geotoolkit.org
 *
 *    (C) 2005-2012, Open Source Geospatial Foundation (OSGeo)
 *    (C) 2010-2012, Geomatys
 *
 *    This library is free software; you can redistribute it and/or
 *    modify it under the terms of the GNU Lesser General Public
 *    License as published by the Free Software Foundation;
 *    version 2.1 of the License.
 *
 *    This library is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 *    Lesser General Public License for more details.
 */
package org.geotoolkit.maven.unopkg;

import java.io.File;
import java.io.IOException;

import org.apache.maven.plugin.AbstractMojo;
import org.apache.maven.plugin.MojoExecutionException;
import org.codehaus.plexus.util.FileUtils;


// Note: javadoc in class and fields descriptions must be XHTML.
/**
 * Compiles Java interfaces from OpenOffice IDL files. In an ideal world, this plugin should
 * executes <code>idlc</code> on the <code>*.idl</code> files, then <code>regmerge</code> on
 * the generated <code>*.urd</code> files, then <code>javamaker</code> on the generated
 * <code>*.rdb</code> files. However, since the above mentioned tools are native and would
 * require a manual installation on every developer machine, current version just copies a
 * pre-compiled class file. This copy must occurs after the compilation phase (in order to
 * overwrite the files generated by <code>javac</code>), which is why the usual Maven resources
 * mechanism doesn't fit.
 *
 * @goal javamaker
 * @phase process-classes
 * @description Copies .class files generated from OpenOffice IDL
 *
 * @author Martin Desruisseaux (IRD)
 * @version 3.09
 *
 * @since 3.09 (derived from 2.2)
 */
public class JavaMaker extends AbstractMojo {
    /**
     * Directory where the .class file(s) are located.
     *
     * @parameter expression="${basedir}/src/main/unopkg"
     * @required
     */
    private String sourceDirectory;

    /**
     * Directory where the output Java files will be located.
     *
     * @parameter expression="${project.build.outputDirectory}"
     * @required
     */
    private String outputDirectory;

    /**
     * Copies the {@code .class} files generated by OpenOffice.
     *
     * @throws MojoExecutionException if the plugin execution failed.
     */
    @Override
    public void execute() throws MojoExecutionException {
        final int n;
        try {
            n = copyClasses(new File(sourceDirectory), new File(outputDirectory));
        } catch (IOException e) {
            throw new MojoExecutionException("Failed to copy *.class files.", e);
        }
        getLog().info("[geotk-unopkg] Copied " + n + " pre-compiled class files.");
    }

    /**
     * Copies {@code *.class} files from source directory to output directory. The output
     * directory structure should already exists. It should be the case if all sources files
     * have been compiled before this method is invoked.
     *
     * @return The number of files copied.
     */
    private static int copyClasses(final File sourceDirectory,
                                   final File outputDirectory) throws IOException
    {
        int n = 0;
        final String[] filenames = sourceDirectory.list();
        for (int i=0; i<filenames.length; i++) {
            final String filename = filenames[i];
            final File file = new File(sourceDirectory, filename);
            if (file.isFile()) {
                if (filename.endsWith(".class") || filename.endsWith(".CLASS")) {
                    FileUtils.copyFileToDirectory(file, outputDirectory);
                    n++;
                }
            } else if (file.isDirectory()) {
                n += copyClasses(file, new File(outputDirectory, filename));
            }
        }
        return n;
    }
}
